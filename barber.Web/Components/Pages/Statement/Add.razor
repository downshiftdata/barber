@page "/statement/add"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = Security.Roles.Editor)]
@rendermode InteractiveServer
@using barber.Core.Extensions;
@inject NavigationManager Navigation;
@inject barber.CodeGen.Services.IStatementService _StatementService;
@inject barber.Data.Interfaces.IQueryService _QueryService;
@inject barber.Data.Interfaces.ICommandService _CommandService;

<PageTitle>Add Statement</PageTitle>

<a class="nav-link" href="/statement/list">Back to List</a>

@if (Statement == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <form method="post" @onsubmit="Submit" @formname="statement-add-form">
        <AntiforgeryToken />
        <div class="form-group">
            <label class="control-label">Description</label>
            <InputText class="form-control" @bind-Value="Statement!.Description" />
        </div>
        <div class="form-group">
            <label class="control-label">Statement Type</label>
            <InputSelect class="form-control" @bind-Value="Statement!.StatementType" @onchange="OnStatementTypeChanged">
                @foreach (var item in System.Enum.GetValues(typeof(barber.Core.Enum.StatementType)))
                {
                    <option value="@item">@item</option>
                }
            </InputSelect>
        </div>
        @if (Statement!.StatementType == barber.Core.Enum.StatementType.Custom)
        {
            <div class="form-group">
                <label class="control-label">Statement Text</label>
                <InputText class="form-control" @bind-Value="Statement!.StatementText" />
            </div>
        }
        else
        {
            <div class="form-group">
                <label class="control-label">Schema Name</label>
                <InputText class="form-control" @bind-Value="Statement!.SchemaName" />
            </div>
            <div class="form-group">
                <label class="control-label">Table Name</label>
                <InputText class="form-control" @bind-Value="Statement!.TableName" />
            </div>
        }
        <div class="form-group">
            <label class="control-label">Statement Detail JSON</label>
            <InputText class="form-control" @bind-Value="Statement!.StatementDetailJson" />
        </div>
        <div class="form-group">
            <label class="control-label">Check Database</label>
            <InputSelect class="form-control" @bind-Value="Statement!.CheckDatabaseKey">
                @foreach (var item in Databases!)
                {
                    <option value="@item.ItemKey">@item.ItemText</option>
                }
            </InputSelect>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" type="submit">Add</button>
        </div>
    </form>
}

@code {
    public System.Collections.Generic.IEnumerable<Data.Models.ListResponse>? Databases { get; set; }

    [Microsoft.AspNetCore.Components.SupplyParameterFromForm]
    public Data.Models.StatementRequest? Statement { get; set; }

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        Databases = await _QueryService.SelectDatabaseList();
        Statement = new Data.Models.StatementRequest();
    }

    private async System.Threading.Tasks.Task Submit()
    {
        if (Statement != null)
        {
            Statement.EditByUserName = "default";
            switch (Statement.StatementType)
            {
                case barber.Core.Enum.StatementType.Custom:
                    Statement.SchemaName = null;
                    Statement.TableName = null;
                    break;
                default:
                    Statement.StatementText = null;
                    break;
            }
            Statement.StatementText = _StatementService.Build(Statement);
            var result = await _CommandService.InsertStatement(Statement);
            Navigation.NavigateTo("/statement/list");
        }
    }

    private void OnStatementTypeChanged(ChangeEventArgs e)
    {
        Statement!.StatementType = e.Value.ToEnum<barber.Core.Enum.StatementType>(barber.Core.Enum.StatementType.None);
    }
}
